<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mq.data.mapper.order.PurchaseOrderDetailMapper">

    <resultMap id="BaseResultMap" type="com.example.mq.data.mapper.order.model.PurchaseOrderDetailDO">
        <result column="id" property="id" />
        <result column="gmt_create" property="gmtCreate"/>
        <result column="gmt_modified" property="gmtModified"/>
        <result column="creator" property="creator"/>
        <result column="modifier" property="operator"/>

        <result column="po_code" property="poCode"/>
        <result column="material_id" property="materialId"/>
        <result column="supplier_code" property="supplierCode"/>
        <result column="plan_num" property="planNum"/>
        <result column="delivery_num" property="deliveryNum"/>
        <result column="receive_num" property="receiveNum"/>
        <result column="remark" property="remark"/>
        <result column="version" property="version"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, gmt_create, gmt_modified, creator, modifier, po_code, material_id,
        supplier_code, plan_num, delivery_num, receive_num, remark, version, is_deleted
    </sql>

    <select id="queryCount" resultType="Integer">
        SELECT COUNT(*)
        FROM mcq_purchase_order_detail
        <where>
            is_delted =0
            <if test = "poCode !=null">
                and po_code = #{poCode}
            </if>
            <if test = "poCodeList !=null and poCodeList.size() >0">
                and po_code in
                <foreach collection="poCodeList" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryDetailList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM mcq_purchase_order_detail
        <where>
            is_delted =0
            <if test = "poCode !=null">
                and po_code = #{poCode}
            </if>
            <if test = "poCodeList !=null and poCodeList.size() >0">
                and po_code in
                <foreach collection="poCodeList" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        <if test="currentIndex !=null and pageSize !=null">
            ORDER BY id DESC
            LIMIT #{currentIndex}, #{pageSize}
        </if>
    </select>

    <insert id="batchAddDetail" parameterType="com.example.mq.data.mapper.order.model.PurchaseOrderDO">
        INSERT INTO mcq_purchase_order_detail
        (po_code, material_id, supplier_code)
        values
        <foreach collection="list" separator="," index="index" item="item">
            (#{item.poCode}, #{item.materialId}, #{item.supplierCode})
        </foreach>

    </insert>

    <update id="batchUpdateDetail" parameterType="com.example.mq.data.mapper.order.model.PurchaseOrderDO">
        <foreach collection="list" item="item" index="index" open="" close="" separator=";">
            UPDATE mcq_purchase_order_detail
            <set>
                <if test="poCode != null">
                    po_code = #{item.poCode},
                </if>
                <if test="materialId != null">
                    material_id = #{item.materialId},
                </if>
                gmt_modified = now(),
                version =version+1
            </set>
            <where>
                where 1 =1
                <if test ="item.poCode !=null">
                    and po_code = #{item.poCode}
                </if>
            </where>
        </foreach>
    </update>

</mapper>